--- 
title: "Análisis de Series de Tiempo"
author: "Grupo 8"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
# url: your book url like https://bookdown.org/yihui/bookdown
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  This is a minimal example of using the bookdown package to write a book.
  The HTML output format for this example is bookdown::gitbook,
  set in the _output.yml file.
link-citations: yes
github-repo: rstudio/bookdown-demo
---

# Propuesta de estructura de datos a trabajar en el curso

La estructura de información a trabajar en el curso será la serie de tiempo correspondiente al índice S&P 500, el cual es un indicador ponderado del valor de capitalización de las 500 compañías más importantes de Estados Unidos.

Calculado por la evaluadora de riesgo Standard & Poor's, este índice captura el 80% del comportamiento de la capitalización bursátil en el mercado americano. En tanto su estructura posee mayor diversidad en el tipo de compañías que lo componen, se tiene que el índice S&P 500 es una buena medida para monitorear y predecir la actividad económica en los enclaves económicos de mayor importancia a nivel global.

En general, la pertinencia del uso de este dataset radica en 3 razones principales:

- En principio, se trata de una estructura de información concisa, legítima en el marco de las actividades de sectores financieros globales, y sin problemas previos en cuanto a la limpieza de sus observaciones. Por lo que una rutina progresiva de análisis sobre esta base de datos se puede dar con mayor facilidad e interpretabilidad.

- El estudio del comportamiento de la capitalización bursátil a nivel global, contenido en el dataset escogido, implica una vista previa y una posible profundización del análisis financiero en el marco de las series de tiempo sobre el comportamiento de firmas, sectores y economías de alto impacto. De esta manera, la aplicación de la rutina de análisis del curso sobre este dataset puede decantar en un ejercicio robusto que puede extenderse más allá de los propósitos básicos de aprendizaje, y conformar una herramienta útil para las intenciones del autor.

- El estudio de la estructura y comportamiento de este dataset como serie de tiempo, inmerso en las dinámicas de intercambio de los mercados de activos financieros, puede representar una herramienta de profundización para la toma de decisiones en materia de optimización de portafolios, y, en general, en materia de comprensión e implementación práctica de instrumentos aplicados de análisis de procesos estocásticos y metodologías de pronósticos.


## Dataset:

```{r booksetup, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE}

# Load necessary libraries
library(rvest)
library(dplyr)

# Load necessary libraries
library(readr)

# Import the downloaded CSV file (change the path accordingly)
spx_data <- read_csv("C:/Users/anaso/OneDrive/Documentos/Desktop/AS1/HistoricalData_1731898394439.csv")

# Display the first few rows of the dataset
head(spx_data)

```
## Summary:

```{r summary1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE}

summary(spx_data)
```
## Scatter plott de la serie de tiempo:

```{r scatter plot1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dpi=96}

# Load necessary libraries
library(ggplot2)
library(dplyr)

# Print the column names to check their exact names
#print(colnames(spx_data))

# Convert the Date column to Date type
spx_data <- spx_data %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%Y"))

# Update the column name here after checking the output of print(colnames(spx_data))
spx_data <- spx_data %>%
  mutate(Close_price = as.numeric(gsub("[^0-9.]", "", `Close/Last`)))  # Update this line with the correct name

# Remove rows with NA values in Date or Close_price
spx_data <- spx_data %>%
  filter(!is.na(Date) & !is.na(Close_price))

# Create the scatter plot
ggplot(spx_data, aes(x = Date, y = Close_price)) +
  geom_point(color = "blue", alpha = 0.6) +
  labs(title = "S&P 500 Close Prices Over Time",
       x = "Date",
       y = "Close Price") +
  theme_minimal()
```

## Fuente:

https://www.nasdaq.com/market-activity/index/spx/historical?page=1&rows_per_page=10&timeline=y10 




```{r setup12, include=TRUE, warning=FALSE, message=FALSE, echo=FALSE, dpi=96}

# Load necessary libraries
library(rvest)
library(dplyr)

# Load necessary libraries
library(readr)

# Import the downloaded CSV file (change the path accordingly)
spx_data <- read_csv("C:/Users/anaso/OneDrive/Documentos/Desktop/AS1/HistoricalData_1731898394439.csv")

# Display the first few rows of the dataset
head(spx_data)

```


# Análisis gráfico del comportamiento del S&P 500

## Tratamiento previo del dataset

Dada la base de datos escogida para las actividades del curso, se procede a realizar un análisis gráfico de los posibles patrones que pueda expresar esta serie de tiempo, particularmente, considerando los conceptos de aproximación a través de media móvil (MA), rezagos en la serie, y estacionariedad.

Inicialmente, se procede con la consecusión del formato del dataset como serie de tiempo, empleando el paquete xts de R, el cual permite estructura el dataset en función de sus fechas, de tal forma que es posible tener en cuenta las brechas generadas por los fines de semana y holidays de esta serie de tiempo en días.

```{r ts setting1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE}

#install.packages("xts")

# Example if the Date is in 'MM/DD/YYYY' format
spx_data$Date <- as.Date(spx_data$Date, format = "%m/%d/%Y")


library(xts)

# Convert your data to an xts object
# Assuming `spx_data` has a column 'Date' in Date format and 'Close/Last' for prices.
spx_Close_ts <- xts(spx_data$`Close/Last`, order.by = spx_data$Date)

head(spx_Close_ts)

```


## Serie de tiempo en bruto

Así, es posible extraer el gráfico preliminar del comportamiento de la serie de tiempo. Nótese que se consideran las fechas desde el 14 de octubre de 2014 hasta el 11 de octubre de 2024.

```{r ts graph 1 1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

plot(spx_Close_ts, main = " ", ylab="S&P500 Index", col = "deepskyblue", xlab= "Date")

title(main="S&P500 Index (Starting at October 14th of 2014)")

```

El gráfico permite denotar una tendencia bastante obvia en cuanto al contexto de la serie de tiempo, ésta es la variación en la actividad del índice en función de la pandemia de 2020, denotada por una fuerte caída del precio del índice alrededor del inicio de 2020. Así, el análisis previo a realizar en este documento considerará un segmento de la serie de tiempo comprendido desde el primero de enero de 2020.

Además, el gráfico de rezagos presentada debajo permite observar el grado de correlación entre las obervaciones diarias y el número de rezagos a evaluar (hasta 30 rezagos), dada la estructura del mercado bursátil inmersa en el comportamiento diario, es de esperarse una alta correlación entre la serie y sus rezagos, de tal manera que una alta correlación positiva puede denotarse incluso hasta el límite del conjunto de gráficos construidos, pues la tendencia de correlación lineal entre las observaciones puede identificarse claramente en todas las instancias, incluso a pesar de que sobre los últimos números de rezagos la tendencia lineal parece englobarse, mostrando signos de grados de aleatoriedad, esto se tendrá en cuenta al graficar la aproximación por rezagos de la serie más adelante.

```{r lagplot1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}


# Subset data for the date range
spx_segment <- spx_Close_ts["2020-01-01/2024-10-11"]

lag.plot(spx_segment, lags = 30, do.lines = FALSE)

```


## Estacionariedad y tratamiento

Un análisis propicio de esta serie de tiempo también implica cónsiderar los posibles efectos estacionales que pueden subyacer en el comportamiento del índice. Así, se provee una aproximación desestacionalizada de la serie a través del método de diferenciación estacional.

La aplicación de diferenciación estacional sustrae el valor del año anterior en la misma fecha para cada observación, de la siguiente manera:

$$ Y^* = Y_t - Y_u  $$
Donde $Y^*$ es la serie de tiempo diferenciada estacionalmente, $Y_t$ es el valor del datapoint, y $Y_u$ es el valor correspondiente a la misma fecha del datapoint en el año inmediatamente anterior.

Esta es una técnica ideal para el tratamiento de efectos estacionales en series de tiempo diarias, pues permite aislar el comportamiento desestacionalizado del índice de manera simple y sin el requerimiento de una alta cantidad de observaciones que puedan denotar periodos estadísticamente significativos (como es requerido en el caso de ejercicios de desestacionalización de series anuales).

A continuación, se presenta el gráfico de comparación entre la serie diferenciada estacionalmente (color azul) y el gráfico del tramo de la serie original en el mismo intervalo de tiempo (color negro), de tal forma que es posible notar la diferencia en sus patrones de crecimiento. Claramente, la serie sin desestacionalizar denota un patrón de crecimiento más estable, en contraposición a los altibajos que presenta la serie desestacionalizada, de tal forma que es posible atribuir este crecimiento sostenido a los efectos estacionales.

```{r seasonality1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}



# Seasonal differencing 
seasonal_diff <- diff(spx_segment, lag = 365)

# Check the result
#plot(seasonal_diff, main = "S&P 500 - Seasonally Differenced Time Series")

spx_segment2 <- spx_Close_ts["2023-01-01/2024-10-11"]
#plot(spx_segment2, main = " ", ylab="S&P500 Index since 2021-01-01", col = "deepskyblue", xlab= "Date")

#title(main="S&P500 Index (Starting at January First of 2021)")


# Plot the original time series and the moving averages
plot(spx_segment2, 
     main = "S&P 500 Seasonally-Treated Series and Raw Series", 
     col = "black", 
     lwd = 1, 
     xlab = "Date", 
     ylab = "Price")

lines(seasonal_diff, col = "blue", lwd = 2)

# Adjust the legend position to "topleft" and include both MAs in the legend
legend("topleft", 
       legend = c("Original", "Seasonal Diff"),
       col = c("black", "blue"), 
       lwd = 2, 
       inset = 1,  # Adjust inset if needed to bring the legend inside the plot area
       cex = 5)     # Adjust `cex` to change the size of the legend text



```

Ahora, teniendo en cuenta la serie desestacionalizada, es posible presentar sus aproximaciones por medio de media movil (MA) y rezagos.


## Aproximación por MA

Inicialmente, se presenta la sucesión de gráficos en los cuales se compara la evoluación de la serie desestacionalizada (en color negro) con sus aproximaciones por medio del cálculo de medias móviles a 10 días (color azul), y a 20 días (color rojo). Nótese cómo, a mayor cantidad de días considerados para la media móvil, se suaviza en mayor medida en comportamiento del índice.


```{r MA1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

#install.packages("zoo")
#install.packages("TTR")

library(zoo)
library(TTR)

# Calculate a 10-day simple moving average
spx_ma_10 <- rollmean(seasonal_diff, k = 10, fill = NA)

# Alternatively, using TTR for a 20-day moving average
spx_ma_20 <- SMA(seasonal_diff, n = 20)

# Plot the original time series and the moving averages
plot(seasonal_diff, 
     main = "S&P 500 Close Prices with Moving Averages", 
     col = "black", 
     lwd = 1, 
     xlab = "Date", 
     ylab = "Price")

lines(spx_ma_10, col = "blue", lwd = 2)
lines(spx_ma_20, col = "red", lwd = 2)

# Adjust the legend position to "topleft" and include both MAs in the legend
legend("topleft", 
       legend = c("Original", "10-day MA", "20-day MA"),
       col = c("black", "blue", "red"), 
       lwd = 2, 
       inset = 1,  # Adjust inset if needed to bring the legend inside the plot area
       cex = 5)     # Adjust `cex` to change the size of the legend text


```


## Aproximación por rezagos

Finalmente, se presenta en el mismo gráfico la serie desestacionalizada (color negro), en conjunto con su aproximación en función de 10 rezagos. Esta cantidad de rezagos se escoge en función de la observación del lag plot, pues, desde la observación informal, puede notarse que es hasta el rezago 10 donde se puede apreciar una relación lineal y directamente proporcional con mayor "pureza", cabe recalcar que este criterio de selección carece de una verificación estadística con rigor, la cual puede alcanzarse al aplicar un modelo autoregresivo sobre la serie de tiempo, sin embargo, este ejercicio limita su alcance a la observación de las tendencias preliminares de manera gráfica, sin profundizar en modelos de ajuste y predicción.  


```{r lagged1, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Create a 1-day lag for the subset
spx_lag_1_segment <- lag(seasonal_diff, n=10)

# Plot the original segment and the lagged values
plot(seasonal_diff, main = "S&P 500 Segment and 10-Day Lag", col = "black", lwd = 1)
lines(spx_lag_1_segment, col = "blue", lwd = 2)
legend("topright", legend = c("Original", "7-day Lag"),
       col = c("black", "blue"), lwd = 1)


```

# Análisis Avanzado de Series de Tiempo

## Descomposición de la Serie de Tiempo

Para el análisis de esta serie de tiempo, se realiza una descomposición aditiva con el fin de identificar y separar los componentes fundamentales: tendencia, estacionalidad y residuo. 

Esta descomposición es fundamental para detectar patrones subyacentes y facilita la toma de decisiones sobre la necesidad de aplicar técnicas adicionales, como la diferenciación o transformaciones, para manejar la variabilidad y controlar posibles sesgos en la serie temporal.

```{r descomponer, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Cargar librerías necesarias
library(xts)
library(forecast)


# Ajusta el argumento frequency 
spx_ts <- ts(spx_segment, frequency = 365)

# Descomposición de la serie
decomposed_spx <- decompose(spx_ts)

# Graficar los componentes
plot(decomposed_spx)

```

La serie temporal del S&P 500 fue descompuesta en sus componentes principales para identificar y analizar su estructura subyacente. A continuación, se describen cada uno de los componentes y la información que aporta al análisis:

Observed (Observado): Este componente representa los valores reales de la serie temporal, incluyendo todas las variaciones de tendencia, estacionariedad y ruido. En esta serie observada, se destaca un comportamiento al alza, especialmente hacia el final del período analizado, lo cual es consistente con la tendencia del S&P 500 en el tiempo.

Trend (Tendencia): El componente de tendencia refleja el cambio general de nivel en la serie a lo largo del tiempo. En este caso, la tendencia muestra un crecimiento estable, con una ligera aceleración hacia el final del período. Este componente es clave para identificar cambios de nivel en el mercado y observar patrones de crecimiento o decrecimiento en el índice.

Seasonal (Estacionariedad): La estacionariedad captura patrones repetitivos que ocurren en intervalos específicos. En el caso del S&P 500, se observan fluctuaciones periódicas, lo que indica la presencia de Estacionariedad en el comportamiento de la serie. Este componente es relevante para comprender ciclos repetitivos que pueden estar asociados a factores estacionales o eventos recurrentes en el mercado.

Random (Ruido): El componente de ruido representa la variabilidad que no puede ser explicada por la tendencia ni por la estacionariedad. En esta serie, se observa una alta variabilidad en el componente de ruido, lo cual sugiere la influencia de factores externos y cambios impredecibles que afectan el mercado. Este componente es especialmente importante para entender la cantidad de incertidumbre o volatilidad en el índice.

## Estacionariedad

Para evaluar la estacionariedad de la serie temporal del S&P 500, se realizó la prueba de Dickey-Fuller Aumentado (ADF). Esta prueba estadística es utilizada comúnmente en series temporales para determinar si una serie es estacionaria, es decir, si sus propiedades estadísticas, como la media y la varianza, son constantes en el tiempo.

El procedimiento es el siguiente:

Aplicación del Test: El test de Dickey-Fuller evalúa la hipótesis nula de que la serie no es estacionaria. Si el p-valor de la prueba es menor que 0.05, se rechaza la hipótesis nula, lo que indica que la serie es estacionaria.

Interpretación de Resultados:

Si el p-valor es menor que 0.05, se concluye que la serie es estacionaria, y no sería necesario aplicar transformaciones adicionales para estabilizarla.
Si el p-valor es mayor que 0.05, se indica que la serie no es estacionaria, por lo que podría ser necesario aplicar una diferenciación para eliminar la tendencia y estabilizar la media de la serie.
La aplicación de esta prueba permite tomar decisiones informadas sobre el tratamiento de la serie temporal y la necesidad de realizar ajustes adicionales para mejorar la precisión de los análisis y modelos de pronóstico.

```{r Estacionariedad, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Cargar la librería necesaria
library(tseries)

# Realizar el test de Dickey-Fuller aumentado (ADF)
adf_test <- adf.test(spx_ts, alternative = "stationary")

# Imprimir los resultados
print(adf_test)

```

El resultado de la prueba de Dickey-Fuller Aumentado (ADF) muestra un p-valor de 0.7025, el cual es significativamente mayor que el umbral de 0.05. Esto implica que no se rechaza la hipótesis nula, lo que indica que la serie temporal del S&P 500 no es estacionaria.

Dado que la serie no es estacionaria, será necesario aplicar una diferenciación para estabilizar la media y remover la tendencia presente en la serie. Esta diferenciación ayudará a que las propiedades estadísticas de la serie se mantengan constantes en el tiempo, lo cual es esencial para construir modelos de pronóstico precisos y evitar resultados sesgados debido a la presencia de una tendencia.


## Diferenciación de la Serie

Para estabilizar la media y eliminar la tendencia de la serie temporal del S&P 500, se aplicó una diferenciación de primer orden.

```{r diferencia, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Aplicar una diferenciación de primer orden
diff_spx <- diff(spx_ts)

# Graficar la serie diferenciada para verificar los resultados
plot(diff_spx, main="Serie Temporal Diferenciada del S&P 500")

```

La gráfica resultante muestra que, tras esta diferenciación, la serie oscila alrededor de un valor cercano a cero, lo cual indica que la tendencia fue efectivamente removida. Esto sugiere que la serie es ahora más adecuada para análisis posteriores, ya que presenta una media estable y se ha eliminado la tendencia a largo plazo que estaba presente en la serie original.

## Transformación para Control de Tendencia y Variabilidad

Antes de proceder con algún tipo de transformación se realiza nuevamente la validación de estacionariedad luego de diferenciación de la serie.

```{r valida, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Realizar el test de Dickey-Fuller en la serie diferenciada
adf_test_diff <- adf.test(diff_spx, alternative = "stationary")

# Imprimir los resultados
print(adf_test_diff)

```

El resultado del test de Dickey-Fuller en la serie diferenciada muestra un p-valor de 0.01, el cual es menor que el umbral de 0.05. Esto implica que se rechaza la hipótesis nula y, por lo tanto, la serie diferenciada es estacionaria.

Dado que la serie temporal del S&P 500, después de la diferenciación de primer orden, muestra estacionariedad con una media constante y no presenta una variabilidad creciente a lo largo del tiempo, se concluye que no es necesario aplicar transformaciones adicionales para estabilizar la varianza. La diferenciación realizada fue suficiente para remover la tendencia y estabilizar la media, lo cual asegura que la serie se encuentra en condiciones adecuadas para ser analizada sin introducir distorsiones adicionales en los datos. Las transformaciones, como logaritmos o raíces cuadradas, suelen emplearse cuando existe una varianza creciente o fluctuaciones amplias, características que no se observan en esta serie diferenciada.

## Conclusiones 

1. Descomposición de la Serie: La descomposición de la serie temporal del S&P 500 permitió identificar los componentes de tendencia, Estacionariedad y ruido. Esto ayudó a separar los patrones subyacentes en la serie y facilitó el análisis detallado de cada uno.

2. Verificación de Estacionariedad: La prueba de Dickey-Fuller aplicada a la serie original confirmó que la serie no era estacionaria, lo cual hizo necesaria la aplicación de una diferenciación de primer orden para estabilizar la media y remover la tendencia.

3. Aplicación de Diferenciación: Tras aplicar la diferenciación de primer orden, la serie temporal mostró un comportamiento estacionario, lo cual fue confirmado mediante una segunda prueba de Dickey-Fuller. La serie diferenciada no presenta tendencia y oscila alrededor de una media constante.

4. No Necesidad de Transformaciones Adicionales: Debido a que la serie diferenciada no muestra problemas de varianza creciente, se concluye que no es necesario aplicar transformaciones adicionales para estabilizar la variabilidad. La serie está en condiciones adecuadas para análisis posteriores o para su inclusión en modelos de pronóstico.


# Introducción a modelos de pronóstico: Modelos de Suavizamiento Exponencial.

El estudio de los modelos de pronóstico en análisis de series de tiempo puede abordarse inicialmente desde la perspectiva de los modelos de Suavizamiento Exponencial, los cuales proveen una estructura intuitiva en el sentido de los componentes de la serie de tiempo analizada, al asumir como supuesto fundamental que los valores futuros de la serie de tiempo dependen de sus valores pasados, definiendo la contribución de estos al emplear ponderaciones exponencialmente decrecientes en los rezagos. Además, en su sofisticación en el modelo Holt-Winters, los modelos de Suavizamiento Exponencial también incluyen la influencia de los componentes de tendencia y estacionalidad.

En esta sección, haremos uso de las propiedades del análisis de Suavizamiento Exponencial al aplicar el Modelo Holt-Winters en sus versiones aditiva y multiplicativa a nuestra serie de tiempo S&P 500. Además, dada la frecuencia diaria de los datos, también evaluaremos la bondad de ajuste del modelo de Suavizamiento Exponencial Simple, el cual sólo considera la influencia ponderada del Nivel (valores pasados), y excluye la posible influencia de los efectos de Tendencia y Estacionalidad. 

## Modelo Holt-Winters aditivo

El modelo Holt-Winters aditivo modela la serie de tiempo en cuestión considerando la relación de Suavizamiento Exponencial y los efectos de Tendencia y Estacionalidad de manera aditiva, generando un esquema de modelación de bastante precisión en el ajuste con respecto a los valores observados de la serie. Esto puede evidenciarse en el siguiente gráfico, al denotar la similitud entre los valores reales de la serie (negro)  y los valores ajustados provistos por el modelo (rojo).

```{r HWES Add, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Additive Holt-Winters model
hw_additive <- HoltWinters(spx_ts, seasonal = "additive")

# View the summary of the model
summary(hw_additive)

# Access parameter values
alpha <- hw_additive$alpha
beta <- hw_additive$beta
gamma <- hw_additive$gamma

# Print the parameter values
cat("Parameter values for Additive Holt-Winters Model:\n")
cat("Alpha (Level):", alpha, "\n")
cat("Beta (Trend):", beta, "\n")
cat("Gamma (Seasonal):", gamma, "\n")




# Plot the fitted values
plot(hw_additive, main = "Additive Holt-Winters Forecast")


```

Además, nótese el comportamiento de los parámetros por componentes de la serie, existiendo una alta contribución del componente de nivel (0,93), una contribución absoluta del componente estacional (1), y una contribución nula del componente de tendencia (0). Este resultado es esperado debido a la naturaleza de actualización diaria y la tendencia relativamente estática del índice S&P 500, y puede apreciarse a profundidad en el gráfico de descomposición del modelo.  


```{r HWES Add 2, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}


# Plot the fitted values
plot(fitted(hw_additive), main = "Additive Holt-Winters Forecast")


```

Así, puede observarse que el comportamiento de la estimación del modelo posee una forma muy similar a la del componente de nivel, que la forma del componente de estacionalidad denota un comportamiento cíclico marcado en la serie modelada, y que, en promedio, la tendencia no varía.

A continuación, se presenta el gráfico de predicción a 30 días futuros de la serie de tiempo desde el modelo Holt-Winters aditivo.

```{r HWES Add 3, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

library(forecast)

# Forecast using the additive model
forecast_additive <- forecast(hw_additive, h = 30) # Forecast for next 12 periods
plot(forecast_additive, main = "Additive Holt-Winters Forecast")

```

Además, la eficiencia en las predicciones del modelo se contrasta en función de la partición 80/20 de la serie en respectivos conjuntos de training y test. De tal forma que un ejercicio de validación cruzada del modelo ajustado en el conjunto de training en contraste con los datos del conjunto de test arroja las métricas de ajuste del modelo, presentadas a continuación.


```{r HWES Add 4, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Define the training size (e.g., 80% of the data)
train_size <- floor(0.8 * length(spx_ts))

# Create training and test sets
train_set <- window(spx_ts, end = c(time(spx_ts)[train_size]))
test_set <- window(spx_ts, start = c(time(spx_ts)[train_size + 1]))


# Fit the additive Holt-Winters model on the training set
hw_additive_train <- HoltWinters(train_set, seasonal = "additive")


# Generate forecast for the test set period
hw_forecast1 <- forecast(hw_additive_train, h = length(test_set))

# Extract the forecasted values
predicted_values1 <- hw_forecast1$mean


# Calculate forecast errors
errors <- test_set - predicted_values1

# Mean Absolute Error (MAE)
MAE <- mean(abs(errors))

# Mean Absolute Percentage Error (MAPE)
MAPE <- mean(abs(errors / test_set)) * 100

# Root Mean Squared Error (RMSE)
RMSE <- sqrt(mean(errors^2))

# Display metrics
cat("Adjustment Metrics for Additive Holt-Winters Model on Test Set:\n")
cat("MAE: ", MAE, "\n")
cat("MAPE: ", MAPE, "%\n")
cat("RMSE: ", RMSE, "\n")



```

En general, las métricas de interés de Error Porcentual Absoluto Medio (MAPE) y Error Cuadrático Medio (RMSE) muestran un error relativo de alrededor del 12%, y un error cuadrático de alrededor de 686, respectivamente. Este resultado indica un ajuste bondadoso en términos relativos y absolutos de las predicciones del modelo aditivo con respecto a los valores centrales provistos por el conjunto de test.

## Modelo Holt-Winters Multiplicativo

Ahora, es posible aplicar la misma rutina de modelación empleando el modelo Holt-Winters multiplicativo, el cual considera la contribución de los componentes de Nivel, Tendencia y Estacionalidad de forma multiplicativa. Este modelo denota resultados similares, con la difirencia respecto del caso aditivo de una menor contribución del componente de Nivel al modelo (0,91).

```{r HWES Mult, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Multiplicative Holt-Winters model
hw_Multiplicative <- HoltWinters(spx_ts, seasonal = "multiplicative")

# View the summary of the model
summary(hw_Multiplicative)

# Access parameter values
alpha <- hw_Multiplicative$alpha
beta <- hw_Multiplicative$beta
gamma <- hw_Multiplicative$gamma

# Print the parameter values
cat("Parameter values for Multiplicative Holt-Winters Model:\n")
cat("Alpha (Level):", alpha, "\n")
cat("Beta (Trend):", beta, "\n")
cat("Gamma (Seasonal):", gamma, "\n")


# Plot the fitted values
plot(hw_Multiplicative, main = "Multiplicative Holt-Winters Forecast")


```

También es posible observar la fuerte influencia del componente de nivel en el comportamiento de los valores ajustados, la persistencia del patrón de estacionalidad, y la nulidad en la influencia del componente de tendencia en el gráfico de descomposición.

```{r HWES Mult 2, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}


# Plot the fitted values
plot(fitted(hw_Multiplicative), main = "Multiplicative Holt-Winters Forecast")


```

Al graficar la predicción a 30 días futuros del modelo, se observa un intervalo de predicción bastante similar al del caso aditivo.

```{r HWES Mult 3, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

library(forecast)

# Forecast using the Multiplicative model
forecast_Multiplicative <- forecast(hw_Multiplicative, h = 30) # Forecast for next 12 periods
plot(forecast_Multiplicative, main = "Multiplicative Holt-Winters Forecast")

```

Esto se refuerza con la similitud en las métricas de ajuste como producto del ejercicio de validación cruzada en el conjunto de Test, existiendo un muy ligero desmejoramiento tanto en MAPE como en RMSE con respecto al caso aditivo. 

```{r HWES Mult 4, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Fit the multiplicative Holt-Winters model on the training set
hw_multiplicative_train <- HoltWinters(train_set, seasonal = "multiplicative")


# Generate forecast for the test set period
hw_forecast2 <- forecast(hw_multiplicative_train, h = length(test_set))

# Extract the forecasted values
predicted_values2 <- hw_forecast2$mean


# Calculate forecast errors
errors <- test_set - predicted_values2

# Mean Absolute Error (MAE)
MAE <- mean(abs(errors))

# Mean Absolute Percentage Error (MAPE)
MAPE <- mean(abs(errors / test_set)) * 100

# Root Mean Squared Error (RMSE)
RMSE <- sqrt(mean(errors^2))

# Display metrics
cat("Adjustment Metrics for Multiplicative Holt-Winters Model on Test Set:\n")
cat("MAE: ", MAE, "\n")
cat("MAPE: ", MAPE, "%\n")
cat("RMSE: ", RMSE, "\n")


```

## Suavizamiento exponencial simple

Finalmente, dada la naturaleza diaria de la serie de tiempo, es necesario explorar la aplicación de un modelo de Suavizamiento Exponencial Simple (SES) sobre el dataset. Este modelo no es más que una reducción del modelo general Holt-Winters, nulificando los componentes de Tendencia y Estacionalidad, y modelando la serie como estrictamente dependiente del componente de Nivel.

```{r SES, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# SES model
hw_SES <- HoltWinters(spx_ts, beta = FALSE, gamma = FALSE)

# View the summary of the model
summary(hw_SES)

# Access parameter values
alpha <- hw_SES$alpha
beta <- hw_SES$beta
gamma <- hw_SES$gamma

# Print the parameter values
cat("Parameter values for SES Model:\n")
cat("Alpha (Level):", alpha, "\n")
cat("Beta (Trend):", beta, "\n")
cat("Gamma (Seasonal):", gamma, "\n")

# Plot the fitted values
plot(hw_SES, main = "SES Model Forecast")


```

Nótese, que gráficamente, se percibe un mejor ajuste del modelo con respecto a las observaciones que en los casos de Holt-Winters aditivo y multiplicativo. Además, el parámetro de ponderación de nivel es casi igual al del caso multiplicativo.

El siguiente gráfico de descomposición denota la restricción de la estimación del modelo a ser exclusivamente dependiente del componente de nivel.

```{r SES 2, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}


# Plot the fitted values
plot(fitted(hw_SES), main = "SES Model Forecast")


```

Nótese cómo, al ejecutar la predicción a 30 días futuros bajo el modelo SES, se obtiene una progresión horizontal de los valores predichos en función del último valor ajustado, siendo éste el valor central de un intervalo de predicción simétrico. Este resultado se da debido a la desaparición de la influencia de la tendencia y la estacionalidad en la predicción, este condicionamiento reduce en gran medida la eficiencia de este modelo, por lo cual también suele llamársele "predicción ingenua".

```{r SES 3, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

library(forecast)

# Forecast using the SES model
forecast_SES <- forecast(hw_SES, h = 30) # Forecast for next 12 periods
plot(forecast_SES, main = "SES model Forecast")

```

Este resultado puede observarse puntualmente en el decrecimiento significativo de la eficiencia del modelo a partir de las métricas obtenidas en la validación cruzada: MAPE 19%, y RMSE 1081.


```{r SES 4, include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Fit the SES model on the training set
hw_SES_train <- HoltWinters(train_set, beta = FALSE, gamma = FALSE)


# Generate forecast for the test set period
SES_forecast <- forecast(hw_SES_train, h = length(test_set))

# Extract the forecasted values
predicted_values3 <- SES_forecast$mean


# Calculate forecast errors
errors <- test_set - predicted_values3

# Mean Absolute Error (MAE)
MAE <- mean(abs(errors))

# Mean Absolute Percentage Error (MAPE)
MAPE <- mean(abs(errors / test_set)) * 100

# Root Mean Squared Error (RMSE)
RMSE <- sqrt(mean(errors^2))

# Display metrics
cat("Adjustment Metrics for SES Model on Test Set:\n")
cat("MAE: ", MAE, "\n")
cat("MAPE: ", MAPE, "%\n")
cat("RMSE: ", RMSE, "\n")


```

En este sentido, dado el análisis realizado y las prepiedades exploradas en el marco del modelo Holt-Winters, resulta indispensable el considerar la influencia de los componentes de Tendencia y Estacionalidad en la serie de tiempo, de tal forma que, de tener que escoger entre las 3 opciones de modelación a disposición para la toma de decisiones en el mercado, el emplear predicciones desde el modelo Holt-Winters aditivo se muestra como la decisión correcta.

# Variables en el tiempo, el ajuste a un modelo lineal y estacionario. 

## Introducción.

En este capítulo se analiza la dinámica temporal de las variables del índice S&P 500 para comprender sus tendencias y patrones a lo largo del tiempo. El enfoque principal incluye la evaluación de las variables clave, el ajuste de un modelo lineal que capture relaciones significativas y la validación de la estacionariedad en la serie.

## Perparación de Datos. 

Para analizar la dinámica temporal del índice S&P 500, se inició con la transformación de la columna Date al formato adecuado de fecha, lo que permite realizar análisis temporales y ajustar modelos basados en el tiempo.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Prepare the dataset for Prophet
spx_data_prepared <- spx_data %>%
  rename(ds = Date, y = `Close/Last`) %>% 
  arrange(ds)                            

# Check the prepared dataset
head(spx_data_prepared)

```

## Análisis de las Variables en el Tiempo.

Para comprender las dinámicas temporales del índice S&P 500, se realiza un análisis exploratorio de la serie temporal.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Load the ggplot2 library for creating visualizations
library(ggplot2)

# Create a line plot to visualize the time series of closing prices
ggplot(spx_data_prepared, aes(x = ds, y = y)) +
  geom_line(color = "blue") + # Plot a blue line for the series
  labs(
    title = "S&P 500: Serie Temporal de Precios de Cierre",
    x = "Fecha", # Label for the x-axis
    y = "Precio de Cierre" # Label for the y-axis
  ) +
  theme_minimal() # Apply a minimal theme for better aesthetics

```

La serie temporal del índice S&P 500 muestra una tendencia creciente a lo largo del tiempo, con caídas notables durante 2020, posiblemente relacionadas con la crisis económica derivada de la pandemia de COVID-19. Posteriormente, se observa una recuperación significativa y un crecimiento continuo hasta 2024, destacando el comportamiento positivo reciente del mercado.


## Ajuste de un Modelo Lineal

En este apartado, se ajustó un modelo de regresión lineal para describir la relación entre el tiempo y los precios de cierre del índice S&P 500.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}
# Create a time index to represent the progression of dates numerically
spx_data_prepared$time_index <- seq_along(spx_data_prepared$ds)

# Fit a linear regression model: closing prices (y) as a function of time index
linear_model <- lm(y ~ time_index, data = spx_data_prepared)

# Display the summary of the linear model
summary(linear_model)
```

A pesar de su robustez en capturar la tendencia general, el modelo no explica completamente las fluctuaciones de corto plazo, como lo refleja un error estándar residual de 329.6 unidades. Esto indica que el ajuste lineal es adecuado para entender la dinámica a largo plazo, pero insuficiente para captar variaciones puntuales o eventos atípicos.

## Visualización del Modelo Lineal

El modelo lineal ajustado muestra que el precio de cierre del S&P 500 tiene una tendencia positiva significativa a lo largo del tiempo, con un crecimiento promedio de 1.372 unidades por incremento del índice temporal. El modelo explica el 90.23% de la variación observada en los datos. Sin embargo, se observan fluctuaciones en los precios que no son capturadas por el modelo, lo que indica que este ajuste puede no ser suficiente para representar las dinámicas de corto plazo del índice.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}
# Plot the data points and the fitted linear regression line
ggplot(spx_data_prepared, aes(x = time_index, y = y)) +
  geom_point(alpha = 0.5, color = "blue") + # Scatter plot of data points
  geom_smooth(method = "lm", color = "red") + # Linear regression line
  labs(
    title = "Modelo Lineal Ajustado a los Precios del S&P 500",
    x = "Índice de Tiempo",
    y = "Precio de Cierre"
  ) +
  theme_minimal()
```


## Evaluación de Estacionariedad

La estacionariedad es un requisito clave para ciertos modelos de series temporales, como ARIMA. Evaluaremos si la serie del S&P 500 es estacionaria mediante la prueba de Dickey-Fuller aumentada (ADF). Si la serie no es estacionaria, aplicaremos una transformación (como la diferenciación).

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}
# Load the tseries library for the Augmented Dickey-Fuller test
library(tseries)

# Perform the ADF test on the closing prices
adf_test <- adf.test(spx_data_prepared$y, alternative = "stationary")

# Print the p-value to determine stationarity
adf_test$p.value
```

## Ajuste del Modelo ARIMA

Se ajustó un modelo ARIMA(2,1,2) con deriva a la serie temporal del índice S&P 500. Este modelo combina dos términos autorregresivos, una diferenciación para estacionarizar la serie, y dos términos de media móvil. Los coeficientes estimados son estadísticamente significativos, lo que respalda la validez del modelo. Las métricas obtenidas, como un  𝑅𝑀𝑆𝐸 = 36.2988, indican que el modelo ofrece un buen nivel de precisión en sus predicciones.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}
# Load the forecast library for ARIMA modeling
library(forecast)

# Fit an ARIMA model to the original series
arima_model <- auto.arima(spx_data_prepared$y)

# Display the summary of the ARIMA model
summary(arima_model)


# Forecast the next 30 time periods
forecast_arima <- forecast(arima_model, h = 30)

# Plot the forecast
autoplot(forecast_arima) +
  labs(
    title = "Pronóstico del Modelo ARIMA para el S&P 500",
    x = "Fecha",
    y = "Precio de Cierre"
  ) +
  theme_minimal()

```

El grafico muestra el pronóstico del modelo ARIMA para los próximos 30 periodos. Las predicciones reflejan la tendencia ascendente observada en los datos históricos, con un rango de incertidumbre moderado. Este modelo es útil tanto para comprender el comportamiento pasado como para proyectar posibles escenarios futuros del índice S&P 500.

## Conclusiones
El análisis de la serie temporal del índice S&P 500 permitió identificar tendencias y patrones clave, así como realizar pronósticos confiables basados en modelos estadísticos. Los principales hallazgos se resumen a continuación:

Tendencia y Comportamiento General:

La serie temporal del S&P 500 mostró una clara tendencia ascendente durante el período analizado, reflejando el crecimiento sostenido del mercado en los últimos años. Sin embargo, se observaron fluctuaciones importantes durante eventos específicos, como la crisis de 2020, que interrumpieron temporalmente esta tendencia.
Ajuste del Modelo Lineal:

El modelo lineal ajustado capturó la tendencia general de los precios de cierre, explicando el 90.23% de la variación en los datos. Este modelo es útil para comprender el comportamiento a largo plazo, pero no logró captar adecuadamente las fluctuaciones de corto plazo, como caídas abruptas o picos inusuales.
Modelo ARIMA y Pronósticos:

El modelo ARIMA(2,1,2) con deriva proporcionó una representación más precisa de la serie temporal, modelando tanto la tendencia como las variaciones de corto plazo. Este modelo fue utilizado para realizar pronósticos de los próximos 30 períodos, que reflejaron una continuación de la tendencia ascendente del índice, con un rango moderado de incertidumbre.
Implicaciones del Análisis:

Los resultados obtenidos ofrecen una herramienta sólida para analizar el comportamiento histórico y proyectar escenarios futuros del índice S&P 500, lo que puede ser útil para la toma de decisiones estratégicas en el contexto financiero.


# Análisis de Series de Tiempo con Facebook Prophet.

## Introducción.

En este capítulo se aplica el modelo Facebook Prophet para analizar una serie de tiempo basada en datos históricos del índice S&P 500. El objetivo principal es explorar tendencias, estacionalidades y realizar predicciones futuras, complementando los modelos trabajados previamente. Además, se justifica la viabilidad de tratar la serie como una regresión, conectando los hallazgos con enfoques lineales y estacionarios ya planteados.

## Preparación de los Datos.

Para llevar a cabo el análisis con Prophet, fue necesario preparar previamente el dataset spx_data, que contiene información histórica del índice S&P 500, incluyendo la fecha (Date), el precio de cierre (Close/Last), apertura (Open), máximos (High) y mínimos (Low). Prophet requiere que las columnas de fecha y la variable objetivo tengan nombres específicos para procesar los datos correctamente.

Primero, la columna Date se renombró como ds (date stamp) y la columna Close/Last se renombró como y (valor a predecir). Además, los datos fueron ordenados cronológicamente en orden ascendente para garantizar la consistencia temporal del modelo. Este preprocesamiento fue esencial para alinear el formato del dataset con los requisitos de Prophet, asegurando que las fechas fueran interpretadas correctamente y los valores de cierre sirvieran como base para las predicciones.

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Prepare the dataset for Prophet
spx_data_prepared <- spx_data %>%
  rename(ds = Date, y = `Close/Last`) %>% 
  arrange(ds)                            

# Check the prepared dataset
head(spx_data_prepared)

```

## Aplicación del Modelo Prophet.

Con los datos preparados, se aplicó el modelo Prophet para analizar la serie temporal del índice S&P 500. Utilizando las columnas ds (fechas) y y (precio de cierre), el modelo fue ajustado para capturar las tendencias y estacionalidades presentes en los datos históricos.


```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Load Prophet library
library(prophet)

# Fit the Prophet model
model <- prophet(spx_data_prepared)

# Create future dates for predictions 
future <- make_future_dataframe(model, periods = 365)

# Generate predictions
forecast <- predict(model, future)



```

### Gráfico de Predicciones:

```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Plot the forecast
plot(model, forecast)

```


El  gráfico combina los datos históricos del índice S&P 500 con las predicciones generadas por el modelo Prophet. La línea negra representa los valores reales observados desde 2015, mostrando un crecimiento sostenido con fluctuaciones atribuibles a eventos del mercado. La línea azul, que corresponde al pronóstico del modelo, sugiere que el índice mantendrá una tendencia ascendente en el futuro. El área sombreada en azul claro, que representa los intervalos de confianza, es estrecha en el corto plazo, indicando alta precisión en las predicciones inmediatas, y se amplía en el largo plazo, reflejando una mayor incertidumbre debido a factores impredecibles.



### Gráfico de Componentes:
```{r , include=TRUE, warning=FALSE, message=FALSE, echo=TRUE, dev='png', dpi=96}

# Plot forecast components
prophet_plot_components(model, forecast)


```


El  gráfico descompone el comportamiento del índice S&P 500 en tres componentes principales: tendencia, estacionalidad semanal y estacionalidad anual. La tendencia refleja un crecimiento positivo sostenido a largo plazo, alineado con el desempeño histórico del mercado. La estacionalidad semanal muestra variaciones asociadas a los días de la semana, destacando una disminución los fines de semana debido a la inactividad del mercado. Por su parte, la estacionalidad anual identifica patrones cíclicos recurrentes a lo largo del año, posiblemente influenciados por ciclos económicos y eventos estacionales. Estos componentes permiten comprender los factores que afectan el comportamiento del índice y aportan información clave para las predicciones.

## Justificación.

El análisis realizado con Prophet demuestra que la serie de tiempo del índice S&P 500 puede modelarse bajo un enfoque de regresión. Esto se debe a que el modelo descompone la serie en componentes fundamentales, como tendencia, estacionalidad semanal y anual, permitiendo capturar las relaciones temporales inherentes en los datos.

En este caso, el tiempo actúa como la variable independiente, mientras que el valor de cierre (Close/Last) es la variable dependiente. Prophet utiliza un enfoque aditivo, lo que significa que combina las tendencias y patrones estacionales en una fórmula de regresión temporal. Este método permite no solo predecir valores futuros, sino también identificar cómo las fluctuaciones diarias, semanales y anuales influyen en el comportamiento del índice. Por lo tanto, la serie puede justificarse como un problema de regresión, donde cada componente aporta información crucial para el modelo.

Un ejemplo práctico de esta relación se observa en la tendencia a largo plazo, que refleja el crecimiento sostenido del índice a lo largo de los años, mientras que las estacionalidades semanal y anual introducen variaciones más pequeñas pero consistentes, como los cambios en días de operación o ciclos económicos.


## Conclusiones.    

El modelo Prophet demostró ser una herramienta eficaz para analizar y predecir el comportamiento del índice S&P 500. La descomposición de la serie en componentes de tendencia, estacionalidad semanal y estacionalidad anual permitió no solo realizar predicciones precisas, sino también interpretar los patrones subyacentes en los datos históricos.

El enfoque de regresión aplicado en Prophet proporciona una base sólida para justificar el uso de esta técnica en el análisis de series temporales, al tratar el tiempo como predictor y los valores históricos como resultados. Esto refuerza la idea de que los datos financieros, como el índice S&P 500, pueden modelarse y explicarse utilizando metodologías de regresión dentro de un contexto temporal.


